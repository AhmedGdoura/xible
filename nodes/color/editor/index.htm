<style>
	.container {
		width: 100%;
		padding-top: 100%;
		position: relative;
	}

	.wheel {
		position: absolute;
		top: 0;
		left: 0;
		bottom: 0;
		right: 0;
		box-sizing: border-box;
		border-radius: 50%;
		border: 2px solid #3E3E3E;
		width: 100%;
		height: 100%;
		cursor: pointer;
	}

	.selector {
		cursor: pointer;
		height: 5px;
		width: 5px;
		border: 1px solid #000;
		border-radius: 50%;
		background-color: transparent;
		position: absolute;
		top: 50%;
		left: 50%;
	}
</style>
<div class="container">
	<canvas class="wheel"></canvas>
	<div class="selector"></div>
</div>
<input type="hidden" data-outputvalue="hex" />
<script>
	let canvas = this.editorContentEl.getElementsByTagName('canvas')[0];
	let ctx = canvas.getContext('2d');

	let selector = this.editorContentEl.querySelector('.selector');
	let input = this.editorContentEl.getElementsByTagName('input')[0];

	//rgb to hex converter
	function rgbToHex(r, g, b) {
		return ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
	}

	//set the position of the selector in the wheel, based on a mouse input event
	let setColorPositionOnEvent = (event) => {

		let canvasBounding = canvas.getBoundingClientRect();
		let y = (event.pageY - canvasBounding.top) / this.editor.zoom;
		let x = (event.pageX - canvasBounding.left) / this.editor.zoom;

		setColorPosition(x, y);

	}

	//set the position of the selector in the wheel, based on x & y position
	let setColorPosition = (x, y) => {

		//get the mouse position
		selector.style.top = (y - 4) + 'px';
		selector.style.left = (x - 2) + 'px';

		let imageData = ctx.getImageData(x, y, 1, 1).data;
		this.setData({
			hex: rgbToHex(imageData[0], imageData[1], imageData[2]),
			x: x,
			y: y
		});

	}

	//set the correct canvas height and width but only after this node has been appended
	//if we don't do this, the getImageData positions are incorrect
	this.once('append', () => {

		canvas.setAttribute('width', canvas.offsetWidth);
		canvas.setAttribute('height', canvas.offsetHeight);

	})

	//load the color wheel
	let img = new Image();
	img.crossOrigin = 'anonymous';
	img.onload = () => {

		//correct the height and width of the canvas
		//canvas.height = canvas.offsetHeight;
		//canvas.width = canvas.offsetWidth;
		ctx.drawImage(img, 0, 0);

		//set the initial position
		if (typeof this.data.y === 'number' && typeof this.data.x === 'number') {
			setColorPosition(this.data.x, this.data.y);
		}

	}
	img.src = 'https://10.0.0.10:9600/api/nodes/color/editor/wheel.svg';

	//change
	selector.onmousedown = canvas.onmousedown = function(event) {

		//stop this from dragging the node
		event.stopPropagation();

		//hook mousemove
		document.body.addEventListener('mousemove', setColorPositionOnEvent);

		//cancel mousemove
		let mouseUpFn;
		document.body.addEventListener('mouseup', mouseUpFn = (event) => {

			document.body.removeEventListener('mousemove', setColorPositionOnEvent);
			document.body.removeEventListener('mouseup', mouseUpFn);
			mouseUpFn = null;

		});

		setColorPositionOnEvent(event);

	};
</script>
